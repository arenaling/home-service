{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":[],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport {User} from '../../sqldb';\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.findAll({\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider',\n      'id_agency'\n    ]\n  })\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res, next) {\n  var newUser = User.build(req.body);\n  newUser.setDataValue('provider', 'local');\n  // newUser.setDataValue('role', 'user');\n  return newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(user => {\n      if (!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.destroy({ _id: req.params.id })\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res, next) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(user => {\n      if (user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.find({\n    where: {\n      _id: userId\n    },\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider',\n      'id_agency'\n    ]\n  })\n    .then(user => { // don't ever give out the password or salt\n      if (!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res, next) {\n  res.redirect('/');\n}\n"]}